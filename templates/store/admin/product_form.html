{% extends "base.html" %}
{% load static %}

{% block title %}{{ action }} Product - Admin{% endblock %}

{% block extra_js %}
<script>
  // Preview selected images before upload
  document.getElementById('images')?.addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (this.files && this.files.length > 0) {
      Array.from(this.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const col = document.createElement('div');
          col.className = 'col-md-3 mb-3';
          col.innerHTML = `
            <div class="card">
              <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
              <div class="card-body p-2">
                <small class="text-muted">${file.name}</small>
                ${index === 0 ? '<span class="badge bg-success ms-2">Primary</span>' : ''}
              </div>
            </div>
          `;
          preview.appendChild(col);
        };
        reader.readAsDataURL(file);
      });
    }
  });
</script>
{% endblock %}

{% block content %}
<div class="untree_co-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="card">
          <div class="card-header">
            <h3>{{ action }} Product</h3>
          </div>
          <div class="card-body">
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="{{ form.name.id_for_label }}" class="form-label">Product Name *</label>
                  {{ form.name }}
                  {% if form.name.errors %}
                    <div class="text-danger">{{ form.name.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.slug.id_for_label }}" class="form-label">Slug</label>
                  {{ form.slug }}
                  <small class="form-text text-muted">Leave blank to auto-generate from name</small>
                  {% if form.slug.errors %}
                    <div class="text-danger">{{ form.slug.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                  {{ form.category }}
                  {% if form.category.errors %}
                    <div class="text-danger">{{ form.category.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.sku.id_for_label }}" class="form-label">SKU</label>
                  {{ form.sku }}
                  <small class="form-text text-muted">Leave blank to auto-generate</small>
                  {% if form.sku.errors %}
                    <div class="text-danger">{{ form.sku.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="mb-3">
                <label for="{{ form.short_description.id_for_label }}" class="form-label">Short Description</label>
                {{ form.short_description }}
                {% if form.short_description.errors %}
                  <div class="text-danger">{{ form.short_description.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">Description *</label>
                {{ form.description }}
                {% if form.description.errors %}
                  <div class="text-danger">{{ form.description.errors }}</div>
                {% endif %}
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="{{ form.price.id_for_label }}" class="form-label">Price *</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.price }}
                  </div>
                  {% if form.price.errors %}
                    <div class="text-danger">{{ form.price.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-4">
                  <label for="{{ form.compare_at_price.id_for_label }}" class="form-label">Compare at Price</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.compare_at_price }}
                  </div>
                  {% if form.compare_at_price.errors %}
                    <div class="text-danger">{{ form.compare_at_price.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-4">
                  <label for="{{ form.stock.id_for_label }}" class="form-label">Stock *</label>
                  {{ form.stock }}
                  {% if form.stock.errors %}
                    <div class="text-danger">{{ form.stock.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-check">
                    {{ form.is_active }}
                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                      Active
                    </label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    {{ form.is_featured }}
                    <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
                      Featured
                    </label>
                  </div>
                </div>
              </div>

              <hr>
              <h5>SEO Settings</h5>
              
              <div class="mb-3">
                <label for="{{ form.meta_title.id_for_label }}" class="form-label">Meta Title</label>
                {{ form.meta_title }}
                {% if form.meta_title.errors %}
                  <div class="text-danger">{{ form.meta_title.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.meta_description.id_for_label }}" class="form-label">Meta Description</label>
                {{ form.meta_description }}
                {% if form.meta_description.errors %}
                  <div class="text-danger">{{ form.meta_description.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.meta_keywords.id_for_label }}" class="form-label">Meta Keywords</label>
                {{ form.meta_keywords }}
                {% if form.meta_keywords.errors %}
                  <div class="text-danger">{{ form.meta_keywords.errors }}</div>
                {% endif %}
              </div>

              <hr>
              <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #3b5d50;">
                  <h5 class="mb-0 text-white">Product Images</h5>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="images" class="form-label">Upload Images</label>
                    <input type="file" name="images" id="images" class="form-control" multiple accept="image/*">
                    <small class="form-text text-muted">You can select multiple images. The first image will be set as primary.</small>
                    <div id="imagePreview" class="mt-3 row"></div>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <button type="submit" class="btn btn-primary">Save Product</button>
                <a href="{% url 'store:admin_product_list' %}" class="btn btn-secondary">Cancel</a>
              </div>
            </form>
          </div>
        </div>

        <!-- Product Images Section (for existing products) -->
        {% if product %}
        <div class="card mt-4">
          <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #3b5d50;">
            <h5 class="mb-0 text-white">Product Images</h5>
            <a href="{% url 'store:admin_product_image_add' product.pk %}" class="btn btn-light btn-sm">
              <i class="fa fa-plus"></i> Add Image
            </a>
          </div>
          <div class="card-body">
            {% if images %}
              <div class="row">
                {% for image in images %}
                <div class="col-md-3 mb-3">
                  <div class="card">
                    <img src="{{ image.image.url }}" class="card-img-top" alt="{{ image.alt_text|default:product.name }}" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                      <p class="card-text small mb-2">
                        {% if image.is_primary %}
                          <span class="badge bg-success">Primary</span>
                        {% endif %}
                        Order: {{ image.order }}
                      </p>
                      {% if image.alt_text %}
                        <p class="card-text small text-muted">{{ image.alt_text|truncatewords:5 }}</p>
                      {% endif %}
                      <div class="btn-group btn-group-sm w-100" role="group">
                        <a href="{% url 'store:admin_product_image_delete' image.pk %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this image?');">
                          <i class="fa fa-trash"></i> Delete
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted">No images uploaded yet. <a href="{% url 'store:admin_product_image_add' product.pk %}">Add an image</a></p>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

