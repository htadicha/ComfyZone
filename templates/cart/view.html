{% extends "base.html" %}
{% load static %}

{% block title %}Shopping Cart - Furniture Store{% endblock %}

{% block content %}
<div class="hero">
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-lg-5">
        <div class="intro-excerpt">
          <h1>Cart</h1>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="untree_co-section before-footer-section">
  <div class="container">
    {% if items %}
    <div class="row mb-5">
      <form class="col-md-12" method="post">
        {% csrf_token %}
        <div class="site-blocks-table">
          <table class="table">
            <thead>
              <tr>
                <th class="product-thumbnail">Image</th>
                <th class="product-name">Product</th>
                <th class="product-price">Price</th>
                <th class="product-quantity">Quantity</th>
                <th class="product-total">Total</th>
                <th class="product-remove">Remove</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <td class="product-thumbnail">
                  {% if item.product.get_primary_image %}
                    <img src="{{ item.product.get_primary_image.image.url }}" alt="{{ item.product.name }}" class="img-fluid">
                  {% else %}
                    <img src="{% static 'images/product-1.png' %}" alt="{{ item.product.name }}" class="img-fluid">
                  {% endif %}
                </td>
                <td class="product-name">
                  <h2 class="h5 text-black"><a href="{% url 'store:product_detail' slug=item.product.slug %}">{{ item.product.name }}</a></h2>
                  {% if item.variations.all %}
                    <small>Variations: {% for v in item.variations.all %}{{ v.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</small>
                  {% endif %}
                </td>
                <td>${{ item.item_price|default:item.product.price|floatformat:2 }}</td>
                <td>
                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'cart:update' item_id=item.id %}" class="d-inline">
                      {% csrf_token %}
                      <div class="input-group mb-3 d-flex align-items-center quantity-container" style="max-width: 120px;" data-item-id="{{ item.id }}">
                        <div class="input-group-prepend">
                          <button class="btn btn-outline-black decrease" type="button" data-action="decrease">&minus;</button>
                        </div>
                        <input type="text" class="form-control text-center quantity-amount" value="{{ item.quantity }}" readonly>
                        <div class="input-group-append">
                          <button class="btn btn-outline-black increase" type="button" data-action="increase">&plus;</button>
                        </div>
                      </div>
                    </form>
                  {% else %}
                    <div class="input-group mb-3 d-flex align-items-center quantity-container" style="max-width: 120px;" 
                         data-item-key="{{ item.item_key }}" 
                         data-product-id="{{ item.product.id }}"
                         data-variation-ids="{% for v in item.variations.all %}{{ v.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                      <div class="input-group-prepend">
                        <button class="btn btn-outline-black decrease" type="button" onclick="updateSessionQuantity(event, -1)">&minus;</button>
                      </div>
                      <input type="text" class="form-control text-center quantity-amount" value="{{ item.quantity }}" readonly>
                      <div class="input-group-append">
                        <button class="btn btn-outline-black increase" type="button" onclick="updateSessionQuantity(event, 1)">&plus;</button>
                      </div>
                    </div>
                  {% endif %}
                </td>
                <td>${{ item.subtotal|floatformat:2 }}</td>
                <td>
                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'cart:remove' item_id=item.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-black btn-sm">X</button>
                    </form>
                  {% else %}
                    <form method="post" action="{% url 'cart:remove' item_id=0 %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="product_id" value="{{ item.product.id }}">
                      <input type="hidden" name="item_key" value="{{ item.item_key }}">
                      <button type="submit" class="btn btn-black btn-sm">X</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="row mb-5">
          <div class="col-md-6 mb-3 mb-md-0">
            <a href="{% url 'store:shop' %}" class="btn btn-outline-black btn-sm btn-block">Continue Shopping</a>
          </div>
        </div>
      </div>
      <div class="col-md-6 pl-5">
        <div class="row justify-content-end">
          <div class="col-md-7">
            <div class="row">
              <div class="col-md-12 text-right border-bottom mb-5">
                <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <span class="text-black">Subtotal</span>
              </div>
              <div class="col-md-6 text-right">
                <strong class="text-black">${{ total|floatformat:2 }}</strong>
              </div>
            </div>
            <div class="row mb-5">
              <div class="col-md-6">
                <span class="text-black">Total</span>
              </div>
              <div class="col-md-6 text-right">
                <strong class="text-black">${{ total|floatformat:2 }}</strong>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <a href="{% url 'payments:checkout' %}" class="btn btn-black btn-lg py-3 btn-block">Proceed To Checkout</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="row">
      <div class="col-md-12 text-center">
        <h2>Your cart is empty</h2>
        <p><a href="{% url 'store:shop' %}" class="btn btn-primary">Continue Shopping</a></p>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle quantity updates for authenticated users
  document.querySelectorAll('.quantity-container[data-item-id] button[data-action]').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const container = button.closest('.quantity-container');
      const form = container.closest('form');
      const itemId = container.getAttribute('data-item-id');
      const action = button.getAttribute('data-action');
      const change = action === 'increase' ? 1 : -1;
      
      if (!form) {
        console.error('Form not found for item:', itemId);
        return false;
      }
      
      // Find the quantity input
      const quantityInput = container.querySelector('.quantity-amount');
      
      if (!quantityInput) {
        console.error('Quantity input not found for item:', itemId);
        return false;
      }
      
      // Get current quantity and calculate new quantity
      const currentQuantity = parseInt(quantityInput.value) || 1;
      const newQuantity = Math.max(1, currentQuantity + change);
      
      console.log('Updating quantity:', {
        itemId: itemId,
        currentQuantity: currentQuantity,
        change: change,
        newQuantity: newQuantity
      });
      
      // Create or update hidden input for quantity
      let quantityHiddenInput = form.querySelector('input[name="quantity"]');
      if (!quantityHiddenInput) {
        quantityHiddenInput = document.createElement('input');
        quantityHiddenInput.type = 'hidden';
        quantityHiddenInput.name = 'quantity';
        form.appendChild(quantityHiddenInput);
      }
      
      // Set the new quantity
      quantityHiddenInput.value = newQuantity;
      quantityInput.value = newQuantity;
      
      // Disable the button to prevent double submission
      button.disabled = true;
      
      // Submit the form
      console.log('Submitting form with quantity:', newQuantity);
      form.submit();
      
      return false;
    });
  });
});

// Keep the old function for backwards compatibility with inline handlers
function updateQuantity(event, itemId, change) {
  try {
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    const button = event ? (event.target || event.currentTarget) : (window.event ? window.event.srcElement : null);
    
    if (!button) {
      console.error('Button not found');
      return false;
    }
    
    const form = button.closest('form');
    
    if (!form) {
      console.error('Form not found for item:', itemId);
      return false;
    }
    
    const quantityInput = form.querySelector('.quantity-amount');
    
    if (!quantityInput) {
      console.error('Quantity input not found for item:', itemId);
      return false;
    }
    
    const currentQuantity = parseInt(quantityInput.value) || 1;
    const newQuantity = Math.max(1, currentQuantity + change);
    
    let quantityHiddenInput = form.querySelector('input[name="quantity"]');
    if (!quantityHiddenInput) {
      quantityHiddenInput = document.createElement('input');
      quantityHiddenInput.type = 'hidden';
      quantityHiddenInput.name = 'quantity';
      form.appendChild(quantityHiddenInput);
    }
    
    quantityHiddenInput.value = newQuantity;
    quantityInput.value = newQuantity;
    
    button.disabled = true;
    
    console.log('Submitting form with quantity:', newQuantity);
    form.submit();
    
    return false;
  } catch (error) {
    console.error('Error updating quantity:', error);
    return false;
  }
}

function updateSessionQuantity(event, change) {
  // Find the button that was clicked
  const button = event.target;
  // Find the quantity container
  const container = button.closest('.quantity-container');
  // Find the quantity input
  const quantityInput = container.querySelector('.quantity-amount');
  
  if (!quantityInput || !container) {
    console.error('Quantity input or container not found');
    return;
  }
  
  // Get current quantity and calculate new quantity
  const currentQuantity = parseInt(quantityInput.value) || 1;
  const newQuantity = Math.max(1, currentQuantity + change);
  
  // Get data from container
  const productId = container.getAttribute('data-product-id');
  const variationIdsStr = container.getAttribute('data-variation-ids');
  
  // Create a form to submit the update
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{% url "cart:update" item_id=0 %}';
  
  // Get CSRF token
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = csrf;
  form.appendChild(csrfInput);
  
  // Add quantity
  const quantityHiddenInput = document.createElement('input');
  quantityHiddenInput.type = 'hidden';
  quantityHiddenInput.name = 'quantity';
  quantityHiddenInput.value = newQuantity;
  form.appendChild(quantityHiddenInput);
  
  // Add product_id
  const productIdInput = document.createElement('input');
  productIdInput.type = 'hidden';
  productIdInput.name = 'product_id';
  productIdInput.value = productId;
  form.appendChild(productIdInput);
  
  // Add variation_ids if they exist
  if (variationIdsStr && variationIdsStr.trim() !== '') {
    const variationIds = variationIdsStr.split(',').filter(id => id.trim() !== '');
    variationIds.forEach(function(vid) {
      const variationInput = document.createElement('input');
      variationInput.type = 'hidden';
      variationInput.name = 'variations';
      variationInput.value = vid.trim();
      form.appendChild(variationInput);
    });
  }
  
  document.body.appendChild(form);
  form.submit();
}
</script>
{% endblock %}
{% endblock %}

