{% extends "base.html" %}
{% load static %}

{% block title %}Shopping Cart - Furniture Store{% endblock %}

{% block content %}
<div class="hero">
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-lg-5">
        <div class="intro-excerpt">
          <h1>Cart</h1>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="untree_co-section before-footer-section">
  <div class="container">
    {% if items %}
    <div class="row mb-5">
      <form class="col-md-12" method="post">
        {% csrf_token %}
        <div class="site-blocks-table">
          <table class="table">
            <thead>
              <tr>
                <th class="product-thumbnail">Image</th>
                <th class="product-name">Product</th>
                <th class="product-price">Price</th>
                <th class="product-quantity">Quantity</th>
                <th class="product-total">Total</th>
                <th class="product-remove">Remove</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <td class="product-thumbnail">
                  {% if item.product.get_primary_image %}
                    <img src="{{ item.product.get_primary_image.image.url }}" alt="{{ item.product.name }}" class="img-fluid">
                  {% else %}
                    <img src="{% static 'images/product-1.png' %}" alt="{{ item.product.name }}" class="img-fluid">
                  {% endif %}
                </td>
                <td class="product-name">
                  <h2 class="h5 text-black"><a href="{% url 'store:product_detail' slug=item.product.slug %}">{{ item.product.name }}</a></h2>
                  {% if item.variations.all %}
                    <small>Variations: {% for v in item.variations.all %}{{ v.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</small>
                  {% endif %}
                </td>
                <td>${{ item.item_price|default:item.product.price|floatformat:2 }}</td>
                <td>
                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'cart:update' item_id=item.id %}" class="d-inline">
                      {% csrf_token %}
                      <div class="input-group mb-3 d-flex align-items-center quantity-container" style="max-width: 120px;">
                        <div class="input-group-prepend">
                          <button class="btn btn-outline-black decrease" type="button" onclick="updateQuantity({{ item.id }}, -1)">&minus;</button>
                        </div>
                        <input type="text" class="form-control text-center quantity-amount" value="{{ item.quantity }}" readonly>
                        <div class="input-group-append">
                          <button class="btn btn-outline-black increase" type="button" onclick="updateQuantity({{ item.id }}, 1)">&plus;</button>
                        </div>
                      </div>
                    </form>
                  {% else %}
                    <div class="input-group mb-3 d-flex align-items-center quantity-container" style="max-width: 120px;">
                      <div class="input-group-prepend">
                        <button class="btn btn-outline-black decrease" type="button" onclick="updateSessionQuantity('{{ item.item_key }}', -1)">&minus;</button>
                      </div>
                      <input type="text" class="form-control text-center quantity-amount" value="{{ item.quantity }}" readonly>
                      <div class="input-group-append">
                        <button class="btn btn-outline-black increase" type="button" onclick="updateSessionQuantity('{{ item.item_key }}', 1)">&plus;</button>
                      </div>
                    </div>
                  {% endif %}
                </td>
                <td>${{ item.subtotal|floatformat:2 }}</td>
                <td>
                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'cart:remove' item_id=item.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-black btn-sm">X</button>
                    </form>
                  {% else %}
                    <form method="post" action="{% url 'cart:remove' item_id=0 %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="product_id" value="{{ item.product.id }}">
                      <input type="hidden" name="item_key" value="{{ item.item_key }}">
                      <button type="submit" class="btn btn-black btn-sm">X</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="row mb-5">
          <div class="col-md-6 mb-3 mb-md-0">
            <a href="{% url 'store:shop' %}" class="btn btn-outline-black btn-sm btn-block">Continue Shopping</a>
          </div>
        </div>
      </div>
      <div class="col-md-6 pl-5">
        <div class="row justify-content-end">
          <div class="col-md-7">
            <div class="row">
              <div class="col-md-12 text-right border-bottom mb-5">
                <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <span class="text-black">Subtotal</span>
              </div>
              <div class="col-md-6 text-right">
                <strong class="text-black">${{ total|floatformat:2 }}</strong>
              </div>
            </div>
            <div class="row mb-5">
              <div class="col-md-6">
                <span class="text-black">Total</span>
              </div>
              <div class="col-md-6 text-right">
                <strong class="text-black">${{ total|floatformat:2 }}</strong>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <a href="{% url 'payments:checkout' %}" class="btn btn-black btn-lg py-3 btn-block">Proceed To Checkout</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="row">
      <div class="col-md-12 text-center">
        <h2>Your cart is empty</h2>
        <p><a href="{% url 'store:shop' %}" class="btn btn-primary">Continue Shopping</a></p>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% block extra_js %}
<script>
function updateQuantity(itemId, change) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/cart/update/${itemId}/`;
  
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = csrf;
  form.appendChild(csrfInput);
  
  const quantityInput = document.createElement('input');
  quantityInput.type = 'hidden';
  quantityInput.name = 'quantity';
  quantityInput.value = Math.max(1, parseInt(document.querySelector(`input[value="${itemId}"]`)?.value || 1) + change);
  form.appendChild(quantityInput);
  
  document.body.appendChild(form);
  form.submit();
}

function updateSessionQuantity(itemKey, change) {
  // This would need AJAX or form submission
  location.reload();
}
</script>
{% endblock %}
{% endblock %}

