{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Manage Review - {{ product.name }} - Furniture Store{% endblock %}

{% block content %}
<div class="untree_co-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="mb-4">
          <div class="d-flex align-items-center mb-3">
            <a href="{% url 'store:product_detail' slug=product.slug %}" class="text-decoration-none">
              <img src="{% if product.images.first %}{{ product.images.first.image.url }}{% else %}{% static 'images/product-1.png' %}{% endif %}" 
                   alt="{{ product.name }}" 
                   class="img-thumbnail me-3" 
                   style="width: 80px; height: 80px; object-fit: cover;">
            </a>
            <div>
              <h5 class="mb-0"><a href="{% url 'store:product_detail' slug=product.slug %}" class="text-decoration-none">{{ product.name }}</a></h5>
              <p class="text-muted mb-0">${{ product.price }}</p>
            </div>
          </div>
          <h2 class="mb-1">{% if has_review %}Update your review{% else %}Write a review{% endif %}</h2>
          <p class="text-muted mb-0">Share your experience to help other shoppers make confident decisions.</p>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-body">
            <form method="post" id="reviewForm">
              {% csrf_token %}

              <div class="mb-4">
                <label class="form-label fw-bold">Rating <span class="text-danger">*</span></label>
                <div class="star-rating" id="starRating" aria-label="Select a star rating">
                  {% for i in "12345" %}
                    <span class="star" data-rating="{{ forloop.counter }}">★</span>
                  {% endfor %}
                </div>
                <small class="text-muted d-block mt-2">Click on a star to rate between 1 (poor) and 5 (excellent)</small>
                {% if form.rating.errors %}
                  <div class="text-danger mt-1">{{ form.rating.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.title.id_for_label }}" class="form-label">Review title</label>
                {{ form.title }}
                {% if form.title.errors %}
                  <div class="text-danger mt-1">{{ form.title.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-4">
                <label for="{{ form.comment.id_for_label }}" class="form-label">Tell us more <span class="text-danger">*</span></label>
                {{ form.comment }}
                {% if form.comment.errors %}
                  <div class="text-danger mt-1">{{ form.comment.errors }}</div>
                {% endif %}
              </div>

              {{ form.rating }}

              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                  {% if has_review %}Update review{% else %}Submit review{% endif %}
                </button>
                <a href="{% url 'store:product_detail' slug=product.slug %}" class="btn btn-outline-secondary">Cancel</a>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Review status</h5>
            {% if review %}
              <p class="mb-1"><strong>Current status:</strong>
                {% if review.is_approved %}
                  <span class="badge bg-success">Published</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Awaiting moderation</span>
                {% endif %}
              </p>
              <p class="text-muted mb-2">Last updated {{ review.updated_at|date:"M d, Y" }}</p>
              <p class="mb-0">{{ review.comment|truncatewords:30 }}</p>
              <form method="post" action="{% url 'reviews:manage' product_slug=product.slug %}" class="mt-3">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Delete this review?');">Delete review</button>
              </form>
            {% else %}
              <p class="mb-0">You haven't reviewed this product yet. Submit your thoughts to help others.</p>
            {% endif %}
          </div>
        </div>

        {% if recent_reviews %}
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">What others said</h5>
            {% for recent in recent_reviews %}
              <div class="mb-3 border-bottom pb-2">
                <div class="d-flex justify-content-between align-items-center">
                  <strong>{{ recent.user.get_full_name|default:recent.user.email }}</strong>
                  <span class="text-warning small">
                    {% for i in "12345" %}
                      {% if forloop.counter <= recent.rating %}★{% else %}☆{% endif %}
                    {% endfor %}
                  </span>
                </div>
                <p class="mb-1">{{ recent.comment|truncatewords:20 }}</p>
                <small class="text-muted">{{ recent.created_at|date:"M d, Y" }}</small>
              </div>
            {% empty %}
              <p class="mb-0 text-muted">No published reviews yet.</p>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.star-rating {
  font-size: 2rem;
  cursor: pointer;
  display: inline-flex;
  gap: 5px;
}

.star-rating .star {
  color: #ddd;
  transition: color 0.2s;
  user-select: none;
}

.star-rating .star:hover,
.star-rating .star.active {
  color: #ffc107;
}

.star-rating .star:hover ~ .star {
  color: #ddd;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const stars = document.querySelectorAll('.star-rating .star');
  const ratingInput = document.getElementById('id_rating');
  const form = document.getElementById('reviewForm');
  const starContainer = document.querySelector('.star-rating');
  
  let currentRating = ratingInput.value ? parseInt(ratingInput.value, 10) : 0;
  
  if (currentRating > 0) {
    highlightStars(currentRating);
  }
  
  stars.forEach(star => {
    star.addEventListener('click', function() {
      const rating = parseInt(this.getAttribute('data-rating'), 10);
      ratingInput.value = rating;
      currentRating = rating;
      highlightStars(rating);
    });
    
    star.addEventListener('mouseenter', function() {
      const rating = parseInt(this.getAttribute('data-rating'), 10);
      highlightStars(rating);
    });
  });
  
  starContainer.addEventListener('mouseleave', function() {
    highlightStars(currentRating);
  });
  
  function highlightStars(rating) {
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add('active');
      } else {
        star.classList.remove('active');
      }
    });
  }
  
  form.addEventListener('submit', function(e) {
    if (!ratingInput.value || ratingInput.value === '0') {
      e.preventDefault();
      alert('Please select a rating by clicking on the stars.');
      return false;
    }
  });
});
</script>
{% endblock %}



