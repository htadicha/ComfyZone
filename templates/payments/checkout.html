{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Checkout - Furniture Store{% endblock %}

{% block content %}
<div class="hero">
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-lg-5">
        <div class="intro-excerpt">
          <h1>Checkout</h1>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="untree_co-section">
  <div class="container">
    <div class="row mb-5">
      <div class="col-md-12">
        {% if not user.is_authenticated %}
        <div class="border p-4 rounded" role="alert">
          Returning customer? <a href="{% url 'accounts:login' %}">Click here</a> to login
        </div>
        {% endif %}
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-5 mb-md-0">
        <h2 class="h3 mb-3 text-black">Billing Details</h2>
        <div class="p-3 p-lg-5 border bg-white">
          <form id="checkout-form" method="post">
            {% csrf_token %}
            <div class="form-group">
              <label for="c_country" class="text-black">Country <span class="text-danger">*</span></label>
              <textarea id="c_country"
                        name="shipping_country"
                        class="form-control"
                        rows="2"
                        placeholder="Enter your country"
                        required></textarea>
            </div>
            <div class="form-group row">
              <div class="col-md-6">
                <label for="c_fname" class="text-black">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_fname" name="first_name" value="{% if user.is_authenticated %}{{ user.first_name }}{% endif %}" required>
              </div>
              <div class="col-md-6">
                <label for="c_lname" class="text-black">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_lname" name="last_name" value="{% if user.is_authenticated %}{{ user.last_name }}{% endif %}" required>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-md-12">
                <label for="c_address" class="text-black">Address <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_address" name="shipping_street" placeholder="Street address" required>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-md-6">
                <label for="c_state_country" class="text-black">State / Country <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_state_country" name="shipping_state" required>
              </div>
              <div class="col-md-6">
                <label for="c_postal_zip" class="text-black">Postal / Zip <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_postal_zip" name="shipping_postal_code" required>
              </div>
            </div>
            <div class="form-group row mb-5">
              <div class="col-md-6">
                <label for="c_email_address" class="text-black">Email Address <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="c_email_address" name="email" value="{% if user.is_authenticated %}{{ user.email }}{% endif %}" required>
              </div>
              <div class="col-md-6">
                <label for="c_phone" class="text-black">Phone <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_phone" name="phone" placeholder="Phone Number" required>
              </div>
            </div>
            <div class="form-group">
              <label for="c_order_notes" class="text-black">Order Notes</label>
              <textarea name="notes" id="c_order_notes" cols="30" rows="5" class="form-control" placeholder="Write your notes here..."></textarea>
            </div>
          </form>
        </div>
      </div>
      <div class="col-md-6">
        <div class="row mb-5">
          <div class="col-md-12">
            <h2 class="h3 mb-3 text-black">Your Order</h2>
            <div class="p-3 p-lg-5 border bg-white">
              <table class="table site-block-order-table mb-5">
                <thead>
                  <th>Product</th>
                  <th>Total</th>
                </thead>
                <tbody>
                  {% for item in items %}
                  <tr>
                    <td>{{ item.product.name }} <strong class="mx-2">x</strong> {{ item.quantity }}</td>
                    <td>${{ item.subtotal|floatformat:2 }}</td>
                  </tr>
                  {% endfor %}
                  <tr>
                    <td class="text-black font-weight-bold"><strong>Cart Subtotal</strong></td>
                    <td class="text-black">${{ subtotal|floatformat:2 }}</td>
                  </tr>
                  <tr>
                    <td class="text-black font-weight-bold"><strong>Tax</strong></td>
                    <td class="text-black">${{ tax|floatformat:2 }}</td>
                  </tr>
                  <tr>
                    <td class="text-black font-weight-bold"><strong>Shipping</strong></td>
                    <td class="text-black">${{ shipping_cost|floatformat:2 }}</td>
                  </tr>
                  <tr>
                    <td class="text-black font-weight-bold"><strong>Order Total</strong></td>
                    <td class="text-black font-weight-bold"><strong>${{ total|floatformat:2 }}</strong></td>
                  </tr>
                </tbody>
              </table>

              <div class="form-group">
                <button id="checkout-button" class="btn btn-black btn-lg py-3 btn-block">Place Order</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('{{ stripe_publishable_key }}');
  const checkoutButton = document.getElementById('checkout-button');
  
  checkoutButton.addEventListener('click', function() {
    const form = document.getElementById('checkout-form');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    checkoutButton.disabled = true;
    checkoutButton.textContent = 'Processing...';
    
    fetch('{% url "payments:create_checkout_session" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: new URLSearchParams(new FormData(form))
    })
    .then(response => response.json())
    .then(data => {
      if (data.sessionId) {
        return stripe.redirectToCheckout({ sessionId: data.sessionId });
      } else {
        alert('Error: ' + (data.error || 'Failed to create checkout session'));
        checkoutButton.disabled = false;
        checkoutButton.textContent = 'Place Order';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
      checkoutButton.disabled = false;
      checkoutButton.textContent = 'Place Order';
    });
  });
</script>
{% endblock %}
{% endblock %}


